---
title: "Tudor England Urban Scaling"
subtitle: "Part 1"
author: "Rudolf Cesaretti"
date: "2019-08-09"
output: html_document
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 3
    number_sections: false
    code_folding: show
    keep_md: true
    highlight: tango
    theme: sandstone
---

Please direct any questions and comments to Rudolf Cesaretti (rcesaret@asu.edu)

Analyses in this 'Data Replication' script were performed in R versions 3.4.3 (2017-11-30) and 3.6.0 (2019-04-26). R-Studio is ideal for viewing and manipulating this file. 

The subsections of this script, indicated by triple-pound-sign comment lines, specify which subsections they correspond to in the main text (e.g. "4.1 Data Quality") and in the online Appendix (e.g. "A1.1 Distributional Analysis")

The additional R packages required in each section are indicated at the top of each section. To download the requisite packages to your library, simply un-comment-out the function "install.packages()", and make sure you have a secure connection to the internet.

This file requires that the working-directory be set to a local folder that includes "main_dataset.csv", "add_taxpayers.csv", "WCS.csv", "resid_coords_geog.csv", and "TudorCounties.csv" which are included in the online supplementary materials

Commands to export figures (as .tif files) and tables (as .csv files) have also been commented-out

## Preliminaries

### Clear Workspace

```{r}
# clear workspace
rm(list = ls())
```



### Set Project Working Directory Folders

```{r}
# Use an environment to store the directory paths
WD <- new.env()

# SET YOUR LOCAL DIRECTORY LOCATION HERE:
WD$dir <- "C:/Users/TJ McMote/ASU Dropbox/Rudolf Cesaretti/GitHubRepos/TudorEnglandUrbanScaling/"
# Adjust the directory path as per your system

# Creating subdirectories using paste0 function
WD$analysis <- paste0(WD$dir, "analysis/")
WD$data_r <- paste0(WD$dir, "data/raw/")
WD$data_p <- paste0(WD$dir, "data/processed/")
WD$figs <- paste0(WD$dir, "figures/")
WD$funcs <- paste0(WD$dir, "R/")
```




### Load Custom R Functions

```{r}
#Read in custom R functions located in the WD$R directory folder

# Custom function R file names
functions <- c("ks_test_tidy.R", "histogram_density.R", 
               "ks_ecdf_ci_fit.R", "gg_histogram_density.R", 
               "gg_ks_ecdf_ci_fit.R") 

invisible(lapply(functions, function(filename) {
  source(file.path(WD$funcs, filename))
}))

rm(functions) # Remove the vector of function filenames from the environment
```





### Load Required Packages

```{r}
# List of required packages
required_pkgs <- c("knitr", "MASS", "NSM3")

# Check which packages are not yet installed
to_install <- required_pkgs[!required_pkgs %in% installed.packages()]

# Install the missing packages
if (length(to_install) > 0) {
  install.packages(to_install)
}

# Load all required packages
invisible(sapply(required_pkgs, requireNamespace))

# Clean up the environment
rm(required_pkgs, to_install)
```





### Load Data

```{r}
# Upload datasets from working directory
main_dataset <- read.csv(file = paste0(WD$data_r, "main_dataset.csv"), header=TRUE, sep=",")

add_taxpayers <- read.csv(file = paste0(WD$data_r, "add_taxpayers.csv"), header=TRUE, sep=",")

```



## 4.1 Data Quality and A1.1 Distributional Analysis


#### Figure A1: Histograms of the Lay Subsidy data (n = 93)

```{r}
# Define output file
png(
  filename = paste0(WD$figs, "Fig_A1_Hists.png"),
  width = 9,
  height = 4,
  units = "in",
  res = 300,
  bg = "white",
  family = "",
  restoreConsole = TRUE,
  type = "windows"
)

# Set up a 1x2 plotting layout
par(mfrow = c(1, 2))

# Plot Figure A1a
histogram_density(
  data = main_dataset$Log_Tax,
  breaks = seq(2, 7, 0.2),
  main_title = "(a)",
  x_label = "Log Tax (£)",
  y_label = "Frequency",
  file_name = NULL, # Plot directly
  fig_letter = "(a)"
)

# Plot Figure A1b
histogram_density(
  data = main_dataset$Log_Taxpayers,
  breaks = seq(4.5, 7.5, 0.2),
  main_title = "(b)",
  x_label = "Log Taxpayers",
  y_label = "Frequency",
  file_name = NULL, # Plot directly
  fig_letter = "(b)"
)

# Close the TIFF device
dev.off()

# Reset plotting parameters
par(mfrow = c(1, 1))

```



#### Kolmogorov-Smirnov test for Log Tax data (n = 93)

```{r}

knitr::include_graphics(paste0(WD$figs, "Fig_A1_Hists.png"), 
                        rel_path = getOption("knitr.graphics.rel_path", FALSE))

x <- ks_test_tidy(main_dataset, "Log_Tax", signif_digits = 3)
knitr::kable(x, caption = "Kolmogorov-Smirnov test for Log Tax data (n = 93)")

rm(x)

```





#### Figure A2: Kolmogorov-Smirnov Test Plots with 95% C.I.s

```{r}
# Define output file
png(
  filename = paste0(WD$figs, "Fig_A2_KS.png"),
  width = 8,
  height = 4,
  units = "in",
  res = 300,
  bg = "white",
  family = "",
  restoreConsole = TRUE,
  type = "windows"
)

# Set up a 1x2 plotting layout
par(mfrow = c(1, 2))

# Plot Figure A2a
ks_ecdf_ci_fit(
  data = main_dataset$Log_Tax,
  main_title = "(a)",
  x_label = "Log Tax (£)",
  y_label = "ECDF(Log Tax)",
  file_name = NULL # Do not save individual files
)

# Plot Figure A2b
ks_ecdf_ci_fit(
  data = main_dataset$Log_Taxpayers,
  main_title = "(b)",
  x_label = "Log Taxpayers",
  y_label = "ECDF(Log Taxpayers)",
  file_name = NULL # Do not save individual files
)

# Close the png device
dev.off()

# Reset plotting parameters
par(mfrow = c(1, 1))

knitr::include_graphics(paste0(WD$figs, "Fig_A2_KS.png"), 
                        rel_path = getOption("knitr.graphics.rel_path", FALSE))

```





#### Figure A3: Zipfian Tail of Taxpayer Count Log-Log Rank-Size Plot

```{r}

png(
  filename = paste0(WD$figs, "Fig_A3_Zipf.png"),
  width = 5,
  height = 5,
  units = "in",
  res = 300,
  bg = "white",
  family = "",
  restoreConsole = TRUE,
  type = "windows"
)

plot(
  main_dataset$Log_Rank,
  main_dataset$Log_Taxpayers,
  main = "Zipfian Taxpayers Tail",
  cex.main = 2,
  pch = 16,
  font.main = 2,
  font.lab = 2,
  xlab = "Log Rank",
  ylab = "Log Taxpayers"
)

abline(
  a = max(main_dataset$Log_Taxpayers),
  b = -0.35,
  col = "red",
  lwd = 2.5
)

text(3,
     7.15,
     "Ln(Taxpayers) = 7.27 - 0.35(Ln(Rank))",
     cex = 0.8,
     font = 2)

dev.off()


knitr::include_graphics(paste0(WD$figs, "Fig_A3_Zipf.png"), 
                        rel_path = getOption("knitr.graphics.rel_path", FALSE))
```







#### Figure A3: Zipfian Tail of Taxpayer Count Log-Log Rank-Size Plot

```{r}

png(
  filename = paste0(WD$figs, "Fig_A3_Zipf.png"),
  width = 5,
  height = 5,
  units = "in",
  res = 300,
  bg = "white",
  family = "",
  restoreConsole = TRUE,
  type = "windows"
)

plot(
  main_dataset$Log_Rank,
  main_dataset$Log_Taxpayers,
  main = "Zipfian Taxpayers Tail",
  cex.main = 2,
  pch = 16,
  font.main = 2,
  font.lab = 2,
  xlab = "Log Rank",
  ylab = "Log Taxpayers"
)

abline(
  a = max(main_dataset$Log_Taxpayers),
  b = -0.35,
  col = "red",
  lwd = 2.5
)

text(3,
     7.15,
     "Ln(Taxpayers) = 7.27 - 0.35(Ln(Rank))",
     cex = 0.8,
     font = 2)

dev.off()


knitr::include_graphics(paste0(WD$figs, "Fig_A3_Zipf.png"), 
                        rel_path = getOption("knitr.graphics.rel_path", FALSE))
```



